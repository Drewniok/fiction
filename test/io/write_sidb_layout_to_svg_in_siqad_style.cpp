//
// Created by Jan Drewniok on 05.11.24.
//

#include <catch2/catch_template_test_macros.hpp>
#include <catch2/catch_test_macros.hpp>

#include "utils/version_info.hpp"

#include <fiction/io/write_sidb_layout_to_svg_in_siqad_style.hpp>
#include <fiction/layouts/cell_level_layout.hpp>
#include <fiction/technology/cell_technologies.hpp>
#include <fiction/technology/charge_distribution_surface.hpp>
#include <fiction/technology/sidb_charge_state.hpp>
#include <fiction/types.hpp>

#include <fmt/format.h>

#include <sstream>
#include <string>

using namespace fiction;

auto normalize_svg = [](const std::string& svg) noexcept
{
    std::string result = svg;

    // Remove all whitespace (spaces, tabs, newlines)
    result.erase(std::remove_if(result.begin(), result.end(), ::isspace), result.end());

    return result;
};

const std::string expected_svg_bright_cell_level = fmt::format(R"(<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by {} ({}) -->
<svg
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:cc="http://creativecommons.org/ns#"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 19.2 23.04"
    version="1.1">
    <metadata>
        <rdf:RDF>
            <cc:Work rdf:about="">
                <dc:format>image/svg+xml</dc:format>
                <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                <dc:title></dc:title>
            </cc:Work>
        </rdf:RDF>
    </metadata>

<defs>
    <!-- lattice point -->
    <circle id="lattice_point" cx="0" cy="0" r="0.3"/>
    <!-- SiDB -->
    <circle id="sidb_dot" cx="0" cy="0" r="0.9"/>
</defs>
 <!-- PATH_DEFINITION placeholder -->
    <rect x="0" y="0" width="19.2" height="23.04" style="fill:#ffffff;"/> <!-- Background rectangle placeholder -->
    <g>
        <use xlink:href="#lattice_point" x="3.84" y="7.68" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="7.68" y="7.68" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="11.52" y="7.68" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="15.36" y="7.68" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="3.84" y="9.93" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="7.68" y="9.93" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="11.52" y="9.93" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="15.36" y="9.93" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="3.84" y="15.36" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="7.68" y="15.36" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="11.52" y="15.36" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="15.36" y="15.36" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="3.84" y="17.61" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="7.68" y="17.61" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="11.52" y="17.61" style="fill:#6e7175;"/><use xlink:href="#lattice_point" x="15.36" y="17.61" style="fill:#6e7175;"/><use xlink:href="#sidb_dot" x="3.84" y="7.68" style="fill:#ffffff; fill-opacity:1; stroke:#C8C8C8; stroke-width:0.3;"/><use xlink:href="#sidb_dot" x="7.68" y="7.68" style="fill:#ffffff; fill-opacity:1; stroke:#C8C8C8; stroke-width:0.3;"/><use xlink:href="#sidb_dot" x="7.68" y="9.93" style="fill:#ffffff; fill-opacity:1; stroke:#C8C8C8; stroke-width:0.3;"/><use xlink:href="#sidb_dot" x="15.36" y="17.61" style="fill:#ffffff; fill-opacity:1; stroke:#C8C8C8; stroke-width:0.3;"/> <!-- SVG content placeholder -->
    </g>
</svg>)",
                                                               FICTION_VERSION, FICTION_REPO);

const std::string expected_svg_dark_cell_level = fmt::format(R"(<?xml version="1.0" encoding="UTF-8" standalone="no"?>
            <!-- Generated by {} ({}) -->
            <svg
                xmlns:dc="http://purl.org/dc/elements/1.1/"
                xmlns:cc="http://creativecommons.org/ns#"
                xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
                xmlns:svg="http://www.w3.org/2000/svg"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 19.2 23.04"
                version="1.1">
                <metadata>
                    <rdf:RDF>
                        <cc:Work rdf:about="">
                            <dc:format>image/svg+xml</dc:format>
                            <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                            <dc:title></dc:title>
                        </cc:Work>
                    </rdf:RDF>
                </metadata>

            <defs>
                <!-- lattice point -->
                <circle id="lattice_point" cx="0" cy="0" r="0.3"/>
                <!-- SiDB -->
                <circle id="sidb_dot" cx="0" cy="0" r="0.9"/>
            </defs>
             <!-- PATH_DEFINITION placeholder -->
                <rect x="0" y="0" width="19.2" height="23.04" style="fill:#25323D;"/> <!-- Background rectangle placeholder -->
                <g>
                    <use xlink:href="#lattice_point" x="3.84" y="7.68" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="7.68" y="7.68" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="11.52" y="7.68" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="15.36" y="7.68" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="3.84" y="9.93" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="7.68" y="9.93" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="11.52" y="9.93" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="15.36" y="9.93" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="3.84" y="15.36" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="7.68" y="15.36" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="11.52" y="15.36" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="15.36" y="15.36" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="3.84" y="17.61" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="7.68" y="17.61" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="11.52" y="17.61" style="fill:#6e7175;"/>
            <use xlink:href="#lattice_point" x="15.36" y="17.61" style="fill:#6e7175;"/>
            <use xlink:href="#sidb_dot" x="3.84" y="7.68" style="fill:#C8C8C8; fill-opacity:1; stroke:#ffffff; stroke-width:0.3;"/>
            <use xlink:href="#sidb_dot" x="7.68" y="7.68" style="fill:#C8C8C8; fill-opacity:1; stroke:#ffffff; stroke-width:0.3;"/>
            <use xlink:href="#sidb_dot" x="7.68" y="9.93" style="fill:#C8C8C8; fill-opacity:1; stroke:#ffffff; stroke-width:0.3;"/>
            <use xlink:href="#sidb_dot" x="15.36" y="17.61" style="fill:#C8C8C8; fill-opacity:1; stroke:#ffffff; stroke-width:0.3;"/> <!-- SVG content placeholder -->
                </g>
            </svg>)",
                                                             FICTION_VERSION, FICTION_REPO);

const std::string expected_svg_bright_charge_distribution =
    fmt::format(R"(<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by {} ({}) -->
<svg
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:cc="http://creativecommons.org/ns#"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 19.2 23.04"
    version="1.1">
    <metadata>
        <rdf:RDF>
            <cc:Work rdf:about="">
                <dc:format>image/svg+xml</dc:format>
                <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                <dc:title></dc:title>
            </cc:Work>
        </rdf:RDF>
    </metadata>

<defs>
    <!-- lattice point -->
    <circle id="lattice_point" cx="0" cy="0" r="0.3"/>
    <!-- SiDB -->
    <circle id="sidb_dot" cx="0" cy="0" r="0.9"/>
</defs>
 <!-- PATH_DEFINITION placeholder -->
    <rect x="0" y="0" width="19.2" height="23.04" style="fill:#ffffff;"/> <!-- Background rectangle placeholder -->
    <g>
        <use xlink:href="#lattice_point" x="3.84" y="7.68" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="7.68" y="7.68" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="11.52" y="7.68" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="15.36" y="7.68" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="3.84" y="9.93" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="7.68" y="9.93" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="11.52" y="9.93" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="15.36" y="9.93" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="3.84" y="15.36" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="7.68" y="15.36" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="11.52" y="15.36" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="15.36" y="15.36" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="3.84" y="17.61" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="7.68" y="17.61" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="11.52" y="17.61" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="15.36" y="17.61" style="fill:#6e7175;"/>
<use xlink:href="#sidb_dot" x="3.84" y="7.68" style="fill:#E34857; fill-opacity:1; stroke:#E34857; stroke-width:0.3;"/>
<use xlink:href="#sidb_dot" x="7.68" y="7.68" style="fill:#ffffff; fill-opacity:0; stroke:#C8C8C8; stroke-width:0.3;"/>
<use xlink:href="#sidb_dot" x="7.68" y="9.93" style="fill:#00ADAE; fill-opacity:1; stroke:#00ADAE; stroke-width:0.3;"/>
<use xlink:href="#sidb_dot" x="15.36" y="17.61" style="fill:#ffffff; fill-opacity:0; stroke:#C8C8C8; stroke-width:0.3;"/> <!-- SVG content placeholder -->
    </g>
</svg>)",
                FICTION_VERSION, FICTION_REPO);

const std::string expected_svg_dark_charge_distribution =
    fmt::format(R"(<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Generated by {} ({}) -->
<svg
    xmlns:dc="http://purl.org/dc/elements/1.1/"
    xmlns:cc="http://creativecommons.org/ns#"
    xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
    xmlns:svg="http://www.w3.org/2000/svg"
    xmlns:xlink="http://www.w3.org/1999/xlink"
    xmlns="http://www.w3.org/2000/svg"
    viewBox="0 0 19.2 23.04"
    version="1.1">
    <metadata>
        <rdf:RDF>
            <cc:Work rdf:about="">
                <dc:format>image/svg+xml</dc:format>
                <dc:type rdf:resource="http://purl.org/dc/dcmitype/StillImage" />
                <dc:title></dc:title>
            </cc:Work>
        </rdf:RDF>
    </metadata>

<defs>
    <!-- lattice point -->
    <circle id="lattice_point" cx="0" cy="0" r="0.3"/>
    <!-- SiDB -->
    <circle id="sidb_dot" cx="0" cy="0" r="0.9"/>
</defs>
 <!-- PATH_DEFINITION placeholder -->
    <rect x="0" y="0" width="19.2" height="23.04" style="fill:#25323D;"/> <!-- Background rectangle placeholder -->
    <g>
        <use xlink:href="#lattice_point" x="3.84" y="7.68" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="7.68" y="7.68" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="11.52" y="7.68" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="15.36" y="7.68" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="3.84" y="9.93" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="7.68" y="9.93" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="11.52" y="9.93" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="15.36" y="9.93" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="3.84" y="15.36" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="7.68" y="15.36" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="11.52" y="15.36" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="15.36" y="15.36" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="3.84" y="17.61" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="7.68" y="17.61" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="11.52" y="17.61" style="fill:#6e7175;"/>
<use xlink:href="#lattice_point" x="15.36" y="17.61" style="fill:#6e7175;"/>
<use xlink:href="#sidb_dot" x="3.84" y="7.68" style="fill:#E34857; fill-opacity:1; stroke:#E34857; stroke-width:0.3;"/>
<use xlink:href="#sidb_dot" x="7.68" y="7.68" style="fill:#C8C8C8; fill-opacity:0; stroke:#ffffff; stroke-width:0.3;"/>
<use xlink:href="#sidb_dot" x="7.68" y="9.93" style="fill:#00ADAE; fill-opacity:1; stroke:#00ADAE; stroke-width:0.3;"/>
<use xlink:href="#sidb_dot" x="15.36" y="17.61" style="fill:#C8C8C8; fill-opacity:0; stroke:#ffffff; stroke-width:0.3;"/> <!-- SVG content placeholder -->
    </g>
</svg>)",
                FICTION_VERSION, FICTION_REPO);

TEMPLATE_TEST_CASE("Generate SIDB layout in SVG for cell-level layout and charge distribution surface",
                   "[write-sidb-layout-svg-in-siqad-style]", sidb_cell_clk_lyt_cube, sidb_100_cell_clk_lyt_cube,
                   sidb_100_cell_clk_lyt, sidb_cell_clk_lyt)
{
    TestType layout{{4, 4}};

    layout.assign_cell_type({0, 0}, sidb_technology::cell_type::NORMAL);
    layout.assign_cell_type({1, 1}, sidb_technology::cell_type::NORMAL);
    layout.assign_cell_type({1, 0}, sidb_technology::cell_type::NORMAL);
    layout.assign_cell_type({3, 3}, sidb_technology::cell_type::NORMAL);

    SECTION("cell-level layout")
    {
        SECTION("bright mode")
        {
            std::stringstream os_bright_cds;

            write_sidb_layout_svg_in_siqad_style_params params{};
            params.cmode = color_mode::BRIGHT;
            write_sidb_layout_to_svg_in_siqad_style(layout, os_bright_cds, params);

            // Retrieve the SVG content
            const auto generated_svg = os_bright_cds.str();

            // Normalize both SVG strings
            const std::string normalized_generated_svg = normalize_svg(generated_svg);
            const std::string normalized_expected_svg  = normalize_svg(expected_svg_bright_cell_level);

            // Perform the comparison
            REQUIRE(normalized_generated_svg == normalized_expected_svg);
        }

        SECTION("dark mode")
        {
            std::stringstream os_bright_cds;

            write_sidb_layout_svg_in_siqad_style_params params{};
            params.cmode = color_mode::DARK;
            write_sidb_layout_to_svg_in_siqad_style(layout, os_bright_cds, params);

            // Retrieve the SVG content
            const auto generated_svg = os_bright_cds.str();

            // Normalize both SVG strings
            const auto normalized_generated_svg = normalize_svg(generated_svg);
            const auto normalized_expected_svg  = normalize_svg(expected_svg_dark_cell_level);

            // Perform the comparison
            REQUIRE(normalized_generated_svg == normalized_expected_svg);
        }
    }
    SECTION("charge distribution")
    {
        charge_distribution_surface cds{layout};
        cds.assign_charge_state({0, 0}, sidb_charge_state::POSITIVE);
        cds.assign_charge_state({1, 1}, sidb_charge_state::NEGATIVE);
        cds.assign_charge_state({1, 0}, sidb_charge_state::NEUTRAL);
        cds.assign_charge_state({3, 3}, sidb_charge_state::NEUTRAL);

        SECTION("bright mode")
        {

            std::stringstream os_bright_cds;

            write_sidb_layout_svg_in_siqad_style_params params{};
            params.cmode = color_mode::BRIGHT;
            write_sidb_layout_to_svg_in_siqad_style(cds, os_bright_cds, params);

            // Retrieve the SVG content
            const auto generated_svg = os_bright_cds.str();

            // Normalize both SVG strings
            const std::string normalized_generated_svg = normalize_svg(generated_svg);
            const std::string normalized_expected_svg  = normalize_svg(expected_svg_bright_charge_distribution);

            // Perform the comparison
            REQUIRE(normalized_generated_svg == normalized_expected_svg);
        }

        SECTION("dark mode")
        {

            std::stringstream os_bright_cds;

            write_sidb_layout_svg_in_siqad_style_params params{};
            params.cmode = color_mode::DARK;
            write_sidb_layout_to_svg_in_siqad_style(cds, os_bright_cds, params);

            // Retrieve the SVG content
            const auto generated_svg = os_bright_cds.str();

            // Normalize both SVG strings
            const auto normalized_generated_svg = normalize_svg(generated_svg);
            const auto normalized_expected_svg  = normalize_svg(expected_svg_dark_charge_distribution);

            // Perform the comparison
            REQUIRE(normalized_generated_svg == normalized_expected_svg);
        }
    }
};
